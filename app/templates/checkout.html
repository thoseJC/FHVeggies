{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Checkout</h2>

    <!-- Order Summary -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h4>Order Summary</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Size/Unit</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in cart %}
                            <tr>
                                <td>
                                    {% if item['type'] == 'premade_box' %}
                                        {% set box = premade_boxes.get(item['id']|string) %}
                                        {% if box %}
                                            {{ box.size|capitalize }} Premade Box
                                        {% else %}
                                            Box Not Found
                                        {% endif %}
                                    {% else %}
                                        {% set regular_item = items.get(item['id']|string) %}
                                        {% if regular_item %}
                                            {{ regular_item.name }}
                                        {% else %}
                                            Item Not Found
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item['type'] == 'premade_box' %}
                                        -
                                    {% else %}
                                        {% set regular_item = items.get(item['id']|string) %}
                                        {{ regular_item.unit_type if regular_item else '-' }}
                                    {% endif %}
                                </td>
                                <td>{{ item['quantity'] }}</td>
                                <td>
                                    {% if item['type'] == 'premade_box' %}
                                        {% set box = premade_boxes.get(item['id']|string) %}
                                        ${{ "%.2f"|format(box.calculate_price() * item['quantity'] if box else 0.00) }}
                                    {% else %}
                                        {% set regular_item = items.get(item['id']|string) %}
                                        ${{ "%.2f"|format(regular_item.price_per_unit * item['quantity'] if regular_item else 0.00) }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.get('cart_item_id') %}
                                        <form action="{{ url_for('shop.remove_from_cart', cart_item_id=item['cart_item_id']) }}" method="GET" style="display: inline;">
                                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                                        </form>
                                    {% else %}
                                        <span class="text-danger">Cannot remove this item</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-4">
                <p><strong>Subtotal(GST incl):</strong> ${{ "%.2f"|format(subtotal) }}</p>
                <p><strong>Discount:</strong> ${{ "%.2f"|format(discount) }}</p>
                <p><strong id="deliveryFee">Delivery Fee: $0.00</strong></p>
                <p><strong id="total">Total: ${{ "%.2f"|format(total) }}</strong></p>
            </div>
        </div>
    </div>

    <!-- Delivery Options and Payment Form -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h4>Delivery and Payment Options</h4>
        </div>
        <div class="card-body">
            <form id="checkoutForm" action="{{ url_for('shop.place_order') }}" method="POST">
                <!-- Delivery Option -->
                <h5>Delivery Option</h5>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="delivery_option" value="pickup" checked>
                    <label class="form-check-label">Pickup</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="delivery_option" value="delivery" id="deliveryOption">
                    <label class="form-check-label">Delivery (only available within a 20 km radius)</label>
                </div>

                <!-- Address Fields -->
                <div id="addressFields" style="display: none; margin-top: 15px;">
                    <div class="form-group mb-2">
                        <label for="street_address">Street Address</label>
                        <input type="text" id="street_address" name="street_address" class="form-control">
                    </div>
                    <div class="form-group mb-2">
                        <label for="city">City</label>
                        <input type="text" id="city" name="city" class="form-control">
                    </div>
                    <div class="form-group mb-2">
                        <label for="postal_code">Postal Code</label>
                        <input type="text" id="postal_code" name="postal_code" class="form-control">
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn btn-success mt-3" id="placeOrderBtn">Proceed to Payment</button>
                <p id="distanceMessage" class="text-danger mt-2" style="display: none;"></p>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const deliveryOption = document.getElementById('deliveryOption');
        const pickupOption = document.querySelector('input[name="delivery_option"][value="pickup"]');
        const addressFields = document.getElementById('addressFields');
        let subtotal = parseFloat("{{ subtotal }}");
        let deliveryFee = 0; // Default delivery fee

        // Show address fields and update fee when "Delivery" is selected
        deliveryOption.addEventListener('change', function () {
            if (deliveryOption.checked) {
                addressFields.style.display = 'block';
                deliveryFee = 10; // Set delivery fee to $10
            } else {
                deliveryFee = 0; // Reset delivery fee when not selected
            }
            updateTotal();
        });

        // Hide address fields and reset fee when "Pickup" is selected
        pickupOption.addEventListener('change', function () {
            if (pickupOption.checked) {
                addressFields.style.display = 'none';
                deliveryFee = 0; // Reset delivery fee for pickup
            }
            updateTotal();
        });

        // Update the total amount displayed on the page
        function updateTotal() {
            const total = subtotal + deliveryFee;
            document.getElementById('deliveryFee').textContent = `Delivery Fee: $${deliveryFee.toFixed(2)}`;
            document.getElementById('total').textContent = `Total: $${total.toFixed(2)}`;
        }

        // Initialize the total when the page loads
        updateTotal();
    });
</script>
{% endblock %}
